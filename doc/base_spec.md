# 🎯 CTF体験アプリ設計書（Godot版）

## 1. 概要

* **目的**: CTF（Capture The Flag）体験をアプリ上で提供する。
* **ユーザー体験**: デスクトップ風のGUI上で、仮想サーバー・ネットワーク・ファイルシステムを操作し、ターミナルや各種ツールを使ってフラグを取得する。
* **拡張性**: 将来的にサーバー種類追加、ネットワーク機能拡張、ファイル生成パターン拡張などが容易に行えるよう設計。

---

## 2. データ管理

### 2.1 Mission JSON

* **用途**: ミッション環境の定義（サーバー、ユーザーFS、ネットワーク、ゴール）
* **トップレベル構造**

| key               | type   | required | description |
| ----------------- | ------ | -------- | ----------- |
| `mission_id`      | string | ✓        | 一意の識別子      |
| `title`           | string | ✓        | ミッション名      |
| `description`     | string | ✓        | 説明文         |
| `difficulty`      | int    | ✓        | 1-5         |
| `user_filesystem` | object | ✓        | ユーザー用FS     |
| `servers`         | array  | ✓        | サーバー情報      |
| `network_devices` | array  | optional | ルーター/スイッチ等  |
| `goals`           | object | ✓        | フラグ等のゴール    |

### 2.2 JSON仕様書（簡略版）

* **ユーザーFS**:

  ```json
  {
	"root": "/",
	"files": [
	  { "path": "/home/user/readme.txt", "type": "text", "content": "hello" }
	]
  }
  ```

* **サーバー**:

  ```json
  {
	"id": "web01",
	"type": "web",
	"filesystem": { ... },
	"network": { ... }
  }
  ```

* **ネットワークデバイス**:

  ```json
  {
	"id": "router1",
	"type": "router",
	"interfaces": [
	  { "name": "ge0/0", "ip": "10.0.0.1", "vlan": 10 }
	]
  }
  ```

* **ゴール**:

  ```json
  { "flag": "FLAG{example}" }
  ```

---

## 3. コア機能設計

### 3.1 MissionLoader / MissionValidator

* **MissionLoader**

  * JSONを読み込み、アプリ内部オブジェクトに変換
  * サーバー、ネットワーク、ユーザーFSを生成
  * **Factory パターン**を適用し、サーバー種別追加時も拡張容易
* **MissionValidator**

  * JSONのバリデーション
  * ファイルタイプ、重複ID、IP/ポート範囲などチェック
  * エラー情報を配列で保持

> Autoloadシングルトンとして `GL_MissionLoader` / `GL_MissionValidator` に設定

---

### 3.2 ファイルシステム（FVS）

* **ユーザーFS**: 操作対象はユーザー専用
* **サーバーFS**: 各サーバーに紐づく
* **機能**

  * ファイル読み書き、検索
  * ノイズ付きフラグ生成
  * ファイルタイプ拡張 (`text`, `log`, `pcap`, `binary`)
* **設計上のポイント**

  * 仮想FSの抽象クラスを作成
  * 将来的に物理FSとの連携も可能

---

### 3.3 サーバーエミュレーター

* **種類**

  * Webサーバー（HTTP GET/POST）
  * アプリケーションサーバー（任意スクリプト実行）
  * ファイルサーバー（FTP/SFTP）
* **拡張性**

  * サーバー種別ごとにクラスを作り、Factoryで生成
  * ポート複数対応、IP複数対応
  * リクエストやパケット処理は `VirtualNetworkEngine` 経由

---

### 3.4 ネットワークエンジン

* **VirtualNetworkEngine**

  * ネットワーク機器・サーバー・ポートをノードとして管理
  * IP/ポートの送受信を仮想的に処理
  * 将来的にパケットキャプチャ、HTTPクライアント、SSH/FTP接続をサポート

---

### 3.5 ターミナル

* コマンドは **GDスクリプト別ファイルで定義**

  * 説明文、バージョン情報も含めて定義
  * 他開発者が簡単に追加可能
* **機能**

  * パイプ `|`、リダイレクト `>` サポート
  * MissionLoader / FVS と連携
  * コマンド履歴、オートコンプリート可能
* **拡張性**

  * CLI コマンドはインターフェース化して追加
  * コマンド実行のユニットテストも容易

---

### 3.6 ミッション実行フロー

1. ミッション選択画面で JSON を選択
2. MissionLoader で環境構築（サーバー、ネットワーク、FS 初期化）
3. GUI デスクトップが起動
4. ユーザーはターミナルやランチャーで各ツールを操作
5. フラグ取得・ゴール達成判定

---

### 3.7 GUI設計

* **メイン画面**

  * デスクトップ風
  * 背景にアイコン/ショートカット
* **MDI (Multiple Document Interface)**

  * ターミナル、ログビューア、ファイルブラウザなどをウィンドウとして展開
* **アプリランチャー & タスクバー**

  * 起動アプリ一覧
  * 実行中タスクの管理
* **拡張性**

  * 各ウィンドウは Node として独立
  * 将来的に Web ブラウザやパケットビューア追加可能

---

### 3.8 ユニットテスト・CI/CD設計

* **テスト対象**

  * MissionValidator / MissionLoader
  * ターミナルコマンド
  * ファイル生成 / ノイズ生成
* **GUT 使用**

  * Godot 4.x 対応
  * JSON ファイルを再帰的にロードしてテスト
  * assert / push_error を利用して合否判定
* **CI/CD**

  * GitHub Actions 等で GUT テスト実行
  * テスト結果に応じてマージ可否判定
  * JSON 形式のミッション追加時の自動バリデーション

---

### 3.9 拡張ポイントまとめ

| 機能       | 拡張内容                      |
| -------- | ------------------------- |
| サーバー     | 新種別追加、プロトコル拡張             |
| ファイルシステム | generator拡張、バイナリノイズ、ログ形式  |
| ネットワーク   | VLAN、複雑ルーティング、パケットフィルタ    |
| ターミナル    | 新コマンド追加、パイプ連携、外部スクリプト呼び出し |
| GUI      | MDIウィンドウ追加、デスクトップテーマ変更    |

---

💡 **補足**

* Mission JSON 仕様書は `/docs/mission_json_spec.md` に整理
* Autoload シングルトンで MissionLoader / Validator を管理
* GUI なしでもテスト可能な設計にしてあるので、TDD で開発を進めやすい
